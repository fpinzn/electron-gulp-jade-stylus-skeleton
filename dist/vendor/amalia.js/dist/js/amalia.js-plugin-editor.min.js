/*! V1.3.0, Â© INA 2015 */
/**
 * Copyright (c) 2015 Institut National de l'Audiovisuel, INA
 * This file is part of amalia.js

 * amalia.js is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

 * Redistributions of source code, javascript and css minified versions
 * must retain the above copyright notice, this list of conditions and the following disclaimer.

 * Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.

 * You should have received a copy of the GNU General Public License
 * along with amalia.js. If not, see <http://www.gnu.org/licenses/>

 *
 * amalia.js is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */

fr.ina.amalia.player.plugins.PluginBase.extend("fr.ina.amalia.player.plugins.MetadataListEditorPlugin",{classCss:"ajs-plugin editor plugin-list-editor",eventTypes:{}},{container:null,loadDataStarted:!1,metadataManager:null,initialize:function(){this._super(),this.settings=$.extend({defaultDataType:"default",defaultAuthor:"amalia.js",defaultColor:"#2196f3",defaultShape:"circle"},this.settings.parameters||{}),this.container=$("<div>",{"class":this.Class.classCss}),this.pluginContainer.append(this.container),this.createHeaderElement(),this.createMetadataListBlock(),this.createFooterElement(),this.defineListeners(),this.metadataManager=this.mediaPlayer.getMetadataManager(),this.loaderContainer.show()},defineListeners:function(){var a=this.mediaPlayer.getMediaPlayer();a.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,{self:this},this.onSelectedMetadataChange),a.on(fr.ina.amalia.player.PlayerEventType.BEGIN_DATA_CHANGE,{self:this},this.onBeginDataChange),a.on(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{self:this},this.onDataChange),a.on(fr.ina.amalia.player.PlayerEventType.END_DATA_CHANGE,{self:this},this.onEndDataChange),null!==this.logger&&this.logger.trace(this.Class.fullName,"definePlayerListeners")},createHeaderElement:function(){var a=$("<div>",{"class":"heading"}),b=$("<h3>",{"class":"title",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_LIST_EDITOR_LABEL_HEADER});a.append(b),this.container.append(a)},createMetadataListBlock:function(){var a=$("<div>",{"class":"body"}),b=$("<ul>",{"class":"listOfmetadata"});a.append(b),this.container.append(a)},createFooterElement:function(){var a=$("<div>",{"class":"footer"}),b=$("<button>",{"class":"add-metadata ajs-icon ajs-icon-plus"}).on("click",{self:this},this.onAddMetadata);a.append(b),this.container.append(a)},updateMetadataListBlock:function(){var a=this.container.find("ul.listOfmetadata");a.empty();var b=this.mediaPlayer.getBlocksMetadata();if(null!==b)for(var c in b){var d=$("<li>",{"class":"item item-"+c,"data-metadata-id":c}),e=$("<span>",{"class":"text",text:c}),f=$("<span>",{"class":"delete ajs-icon ajs-icon-remove"}),g=$("<span>",{"class":"duplicate ajs-icon ajs-icon-reorder"});d.append(e),d.append(f),d.append(g),a.append(d)}a.find("li").on("click",{self:this},this.onSelectMetadata);var h=this.mediaPlayer.getSelectedMetadataId();a.find("li.item").removeClass("selected"),null!==h&&a.find("li.item.item-"+h).addClass("selected"),this.loaderContainer.hide()},setSelectedMetadataId:function(a){this.mediaPlayer.getSelectedMetadataId()!==a&&this.mediaPlayer.setSelectedMetadataId(a)},removeMetadataById:function(a){this.mediaPlayer.deleteAllMetadataById(a),this.updateMetadataListBlock()},duplicateBlock:function(a){var b="_"+fr.ina.amalia.player.helpers.UtilitiesHelper.generateUUID(),c=JSON.parse(JSON.stringify(this.mediaPlayer.getMetadataById(a))),d=this.metadataManager.getBlockMetadata(a);this.metadataManager.updateBlockMetadata(b,{id:b,label:b,type:d.hasOwnProperty("type")?d.type:this.settings.defaultDataType,author:d.hasOwnProperty("author")?d.type:this.settings.defaultAuthor,color:d.hasOwnProperty("color")?d.type:this.settings.defaultColor,shape:d.hasOwnProperty("shape")?d.type:this.settings.defaultShape}),this.mediaPlayer.setMetadataById(b,c),this.mediaPlayer.setSelectedMetadataId(b),this.updateMetadataListBlock()},onAddMetadata:function(a){var b="_"+fr.ina.amalia.player.helpers.UtilitiesHelper.generateUUID();a.data.self.metadataManager.updateBlockMetadata(b,{id:b,label:b,type:a.data.self.settings.defaultDataType,author:a.data.self.settings.defaultAuthor,color:a.data.self.settings.defaultColor,shape:a.data.self.settings.defaultShape}),a.data.self.mediaPlayer.addMetadataById(b,[]),a.data.self.mediaPlayer.setSelectedMetadataId(b),a.data.self.updateMetadataListBlock()},onSelectMetadata:function(a){var b=$(event.currentTarget).attr("data-metadata-id"),c=$(event.target);c.hasClass("delete")?a.data.self.removeMetadataById(b):c.hasClass("duplicate")?a.data.self.duplicateBlock(b):a.data.self.setSelectedMetadataId(b),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onSelectMetadata  : "+b)},onSelectedMetadataChange:function(a,b){if(a.data.self.container.find("ul.listOfmetadata .item").removeClass("selected"),null!==b.metadataId){a.data.self.container.find("ul.listOfmetadata .item.item-"+b.metadataId).addClass("selected");var c=a.data.self.container.find("ul.listOfmetadata .item.item-"+b.metadataId).offset();"object"==typeof c&&c.hasOwnProperty("top")&&a.data.self.container.find("ul.listOfmetadata").stop().animate({scrollTop:c.top},500,"easeInOutExpo")}},onBeginDataChange:function(a){a.data.self.loadDataStarted=!0,null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onBeginDataChange")},onDataChange:function(a){a.data.self.loadDataStarted===!1&&a.data.self.updateMetadataListBlock()},onEndDataChange:function(a){a.data.self.loadDataStarted=!1,a.data.self.updateMetadataListBlock(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"EndDataChange")}}),fr.ina.amalia.player.plugins.PluginBase.extend("fr.ina.amalia.player.plugins.MetadataBlockEditorPlugin",{classCss:"ajs-plugin editor plugin-block-editor",eventTypes:{}},{container:null,loadDataStarted:!1,metadataManager:null,initialize:function(){this._super(),this.settings=$.extend({shapesListOfElements:["legal","facetime","circle"]},this.settings.parameters||{}),this.container=$("<div>",{"class":this.Class.classCss}),this.pluginContainer.append(this.container),this.createHeaderElement(),this.createMetadataBlock(),this.createFooterElement(),this.defineListeners(),this.metadataManager=this.mediaPlayer.getMetadataManager()},createHeaderElement:function(){var a=$("<div>",{"class":"heading"}),b=$("<h3>",{"class":"title",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_LABEL_HEADER});a.append(b),this.container.append(a)},createMetadataBlock:function(){var a=$("<div>",{"class":"body"}),b=$("<div>",{"class":"messages-container"});b.hide();var c=$("<form>",{"class":"formMetadataBlock"}),d=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_ID}),e=$("<input>",{"class":"metadata-id input",name:"id",type:"text",disabled:"disabled",placeholder:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_ID});d.append(e);var f=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_LABAL}),g=$("<input>",{"class":"metadata-label input",name:"label",type:"text",placeholder:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_LABAL});f.append(g);var h=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_TYPE}),i=$("<select>",{"class":"metadata-type select",name:"type"});h.append(i);var j=fr.ina.amalia.player.PluginBindingManager.dataTypes;for(var k in j){var l=$("<option>",{value:j[k].toString(),text:k.toString()});i.append(l)}var m=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_DESCRIPTION}),n=$("<textarea>",{"class":"metadata-description text-area",name:"description",placeholder:"Description"});m.append(n);var o=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_REFERENCE}),p=$("<input>",{"class":"metadata-ref input",name:"ref",type:"text",placeholder:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_REFERENCE});o.append(p);var q=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_AUTHOR}),r=$("<input>",{"class":"metadata-author input",name:"author",type:"text",placeholder:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_AUTHOR});q.append(r);var s=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_SHAPE}),t=$("<p>",{"class":"metadata-shape",placeholder:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_SHAPE});s.append(t);var u=this.settings.shapesListOfElements;for(var v in u){var w=$("<input>",{id:"shape-item-"+u[v].toString(),name:"shape",value:u[v].toString(),type:"radio"}),x=$("<label>",{"for":"shape-item-"+u[v].toString(),"class":"shape ajs-icon ajs-icon-"+u[v].toString()});t.append(w),t.append(x)}var y=$("<div>",{"class":"form-item",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_COLOR}),z=$("<input>",{"class":"metadata-color input",type:"color",name:"color",placeholder:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_BLOCK_EDITOR_FORM_LABEL_METADATA_COLOR});y.append(z),c.append(d),c.append(h),c.append(f),c.append(m),c.append(o),c.append(q),c.append(y),c.append(s),a.append(b),a.append(c),this.container.append(a)},createFooterElement:function(){var a=$("<div>",{"class":"footer"}),b=$("<button>",{"class":"save-metadata ajs-icon ajs-icon-check"}).on("click",{self:this},this.onSaveMetadata);a.append(b),this.container.append(a)},setMessage:function(a,b){if(b=b?b:"info","undefined"!=typeof a&&"undefined"!=typeof a.length){var c=this.container.find(".messages-container");c.empty().removeClass(function(a,b){return(b.match(/(^|\s)type-\S+/g)||[]).join(" ")}).addClass("type-"+b);for(var d=0;d<a.length;d++){var e=$("<p>",{"class":"error",text:a[d].toString()});c.append(e)}0!==a.length?c.show():c.hide()}},clearMessage:function(){var a=this.container.find(".messages-container");a.empty().hide()},defineListeners:function(){var a=this.mediaPlayer.getMediaPlayer();a.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,{self:this},this.onSelectedMetadataChange),null!==this.logger&&this.logger.trace(this.Class.fullName,"definePlayerListeners")},isValidForm:function(a){if("undefined"!=typeof a&&"undefined"!=typeof a.length){var b=this.container.find(".formMetadataBlock");return""===b.find('[name="id"]').val()?a.push("Id is required field"):""===b.find('[name="label"]').val()?a.push("Label is required field"):""===b.find('[name="type"]').val()&&a.push("Type is required field"),0===a.length}return!1},updateMetadata:function(a){var b=this.metadataManager.getBlockMetadata(a),c=this.container.find(".formMetadataBlock");null!==b?(c.find('[name="label"]').val(b.hasOwnProperty("label")?b.label:""),c.find('[name="type"] option[value="'+b.type+'"]').prop("selected",!0),b.type===fr.ina.amalia.player.PluginBindingManager.dataTypes.DEFAULT?c.find('[name="type"]').prop("disabled",!1):c.find('[name="type"]').prop("disabled",!0),c.find('[name="description"]').val(b.hasOwnProperty("description")?b.description:""),c.find('[name="ref"]').val(b.hasOwnProperty("ref")?b.ref:""),c.find('[name="author"]').val(b.hasOwnProperty("author")?b.author:""),c.find('[name="color"]').val(b.hasOwnProperty("color")?b.color:""),c.find('[name="shape"]').first().prop("checked",!0),c.find('[name="shape"][value="'+b.shape+'"]').prop("checked",!0)):(c.find('[name="label"]').val(""),c.find('[name="type"] option').prop("selected",!1),c.find('[name="type"]').prop("disabled",!1),c.find('[name="description"]').val(""),c.find('[name="ref"]').val(""),c.find('[name="author"]').val(""),c.find('[name="color"]').val(""),c.find('[name="shape"]').first().prop("checked",!0)),this.container.find("form.formMetadataBlock .form-item .metadata-id").val(a),this.clearMessage()},saveMetadata:function(){var a=this.container.find(".formMetadataBlock"),b=[];if(this.isValidForm(b)){var c=a.find('[name="id"]').val();this.metadataManager.updateBlockMetadata(c,{id:c,label:fr.ina.amalia.player.helpers.UtilitiesHelper.htmlEscape(a.find('[name="label"]').val()),type:a.find('[name="type"]').val(),description:fr.ina.amalia.player.helpers.UtilitiesHelper.htmlEscape(a.find('[name="description"]').val()),ref:fr.ina.amalia.player.helpers.UtilitiesHelper.htmlEscape(a.find('[name="ref"]').val()),author:fr.ina.amalia.player.helpers.UtilitiesHelper.htmlEscape(a.find('[name="author"]').val()),color:fr.ina.amalia.player.helpers.UtilitiesHelper.htmlEscape(a.find('[name="color"]').val()),shape:fr.ina.amalia.player.helpers.UtilitiesHelper.htmlEscape(a.find('[name="shape"]:checked').val())}),this.updateMetadata(c),this.setMessage(["Saved!"],"info")}else this.setMessage(b,"error")},onSelectedMetadataChange:function(a,b){null!==b.metadataId&&a.data.self.updateMetadata(b.metadataId)},onSaveMetadata:function(a){a.data.self.saveMetadata()}}),fr.ina.amalia.player.plugins.PluginBase.extend("fr.ina.amalia.player.plugins.MetadataItemsEditorPlugin",{classCss:"ajs-plugin editor plugin-items-editor"},{tcin:0,tcout:0,container:null,loadDataStarted:!1,metadataManager:null,metadataId:null,localisationManager:null,initialize:function(){this._super(),this.settings=$.extend({defaultPercentWidth:.1},this.settings.parameters||{}),this.container=$("<div>",{"class":this.Class.classCss}),this.tcin=this.mediaPlayer.getTcOffset(),this.tcout=this.mediaPlayer.getDuration()+this.mediaPlayer.getTcOffset(),this.pluginContainer.append(this.container),this.createHeaderElement(),this.createMetadataItemsBlock(),this.createFooterElement(),this.defineListeners(),this.metadataManager=this.mediaPlayer.getMetadataManager(),this.localisationManager=new fr.ina.amalia.player.LocalisationManager},createHeaderElement:function(){var a=$("<div>",{"class":"heading"}),b=$("<h3>",{"class":"title",text:fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_ITEMS_EDITOR_LABEL_HEADER});a.append(b),this.container.append(a)},createMetadataItemsBlock:function(){var a=$("<div>",{"class":"body"}),b=$("<div>",{"class":"messages-container"}).hide(),c=$("<ul>",{"class":"listOfSelectedItems"});a.append(b),a.append(c),this.container.append(a)},createFooterElement:function(){var a=$("<div>",{"class":"footer"}),b=$("<span>",{"class":"button add ajs-icon ajs-icon-plus"}).on("click",{self:this},this.onAddItem),c=$("<span>",{"class":"button validateAll ajs-icon ajs-icon-check"}).on("click",{self:this},this.onValidateItems),d=$("<span>",{"class":"button clear ajs-icon ajs-icon-eject"}).on("click",{self:this},this.onClearItems);a.append(b),a.append(c),a.append(d),this.container.append(a)},setMessage:function(a,b){if(b=b?b:"info","undefined"!=typeof a&&"undefined"!=typeof a.length){var c=this.container.find(".messages-container");c.empty().removeClass(function(a,b){return(b.match(/(^|\s)type-\S+/g)||[]).join(" ")}).addClass("type-"+b);for(var d=0;d<a.length;d++){var e=$("<p>",{"class":"error",text:a[d].toString()});c.append(e)}0!==a.length?c.show():c.hide()}},clearMessage:function(){var a=this.container.find(".messages-container");a.empty().hide()},defineListeners:function(){var a=this.mediaPlayer.getMediaPlayer();a.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,{self:this},this.onSelectedMetadataChange),a.on(fr.ina.amalia.player.PlayerEventType.SELECTED_ITEMS_CHANGE,{self:this},this.onSelectedItemsChange),a.on(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{self:this},this.onDataChange),null!==this.logger&&this.logger.trace(this.Class.fullName,"definePlayerListeners")},createFormData:function(a){var b=$("<form>",{"class":"form-data"}).data("metadata",a),c=$("<div>",{"class":"form-input"}),d=$("<span>",{"class":"text data-model-label",text:a.hasOwnProperty("label")?a.label:""}),e=$("<input>",{name:"label","class":"input data-model-label",value:a.hasOwnProperty("label")?a.label:"",placeholder:"Label"}).hide();if(c.append(d),c.append(e),b.append(c),a.hasOwnProperty("tcout")){var f=$("<div>",{"class":"form-input"}),g=$("<span>",{"class":"text  data-model-tcin","data-label":"Tc-in: ",text:a.hasOwnProperty("tcin")?"Tc-in: "+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a.tcin,"ms"):""}),h=$("<input>",{name:"tcin","class":"input  data-model-tcin",value:a.hasOwnProperty("tcin")?fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a.tcin,"ms"):"",placeholder:"TC-IN"}).hide();f.append(g),f.append(h),b.append(f);var i=$("<div>",{"class":"form-input"}),j=$("<span>",{"class":"text data-model-tcout","data-label":"Tc-out: ",text:a.hasOwnProperty("tcout")?"Tc-out: "+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a.tcout,"ms"):""}),k=$("<input>",{name:"tcout","class":"input data-model-tcout",value:a.hasOwnProperty("tcout")?fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a.tcout,"ms"):"",placeholder:"TC-OUT"}).hide();i.append(j),i.append(k),b.append(i)}else{var l="number"==typeof a.tc?a.tc:fr.ina.amalia.player.helpers.UtilitiesHelper.convertHourToSeconde(a.tc),m=$("<div>",{"class":"form-input"}),n=$("<span>",{"class":"text data-model-tc","data-label":"Tc: ",text:a.hasOwnProperty("tc")?"Tc: "+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(l,"ms"):""}),o=$("<input>",{name:"tc","class":"input data-model-tc",value:a.hasOwnProperty("tc")?fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(l,"ms"):"",placeholder:"TC"}).hide();m.append(n),m.append(o),b.append(m)}var p=$("<div>",{"class":"form-controls"}),q=$("<span>",{"class":"button valid ajs-icon ajs-icon-check"}),r=$("<span>",{"class":"button remove ajs-icon ajs-icon-eraser"}),s=$("<span>",{"class":"button close ajs-icon ajs-icon-eject"});return p.append(q),p.append(r),p.append(s),b.append(p),b},updateSelectedItems:function(){var a=this.container.find("ul.listOfSelectedItems"),b=this.mediaPlayer.getSelectedItems(),c=a.find("li.item").last(),d=c.length>0?parseInt(c.attr("class").match(/item-([0-9]+)/)[1])+1:0;if(d=isNaN(d)?0:d,"undefined"!=typeof b&&b.hasOwnProperty("length")&&b.length>0)for(var e=0;e<b.length;e++){var f=b[e];if(null!==f&&f.hasOwnProperty("formCreated")&&f.formCreated===!1){var g=this.createFormData(f),h=$("<li>",{"class":"item item-"+e});f.formCreated=!0,h.append(g),a.append(h)}}a.find(".form-input").on("click",{self:this},this.onFormEdit),a.find(".form-input input.input").on("focusout",{self:this},this.onFormFocusout),a.find(".form-data .form-controls .button.valid").on("click",{self:this},this.onSaveForm),a.find(".form-data .form-controls .button.remove").on("click",{self:this},this.onDeleteItem),a.find(".form-data .form-controls .button.close").on("click",{self:this},this.onCloseForm)},_closeItem:function(a){var b=parseInt(a.attr("class").match(/item-([0-9]+)/)[1]),c=a.find("form").first(),d=c.data("metadata");d.selected=!1,d.formCreated=!1,a.remove(),this.metadataManager.removeSelectedItem(b)},_validateItem:function(a){var b=parseInt(a.attr("class").match(/item-([0-9]+)/)[1]),c=a.find("form").first(),d=c.data("metadata"),e=/^[0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{2}$/,f=!1;return e.test(c.find('[name="tc"]').val())?f=!0:"undefined"!=typeof c.find('[name="tcin"]').val()&&"undefined"!=typeof c.find('[name="tcout"]').val()&&(f=e.test(c.find('[name="tcin"]').val())&&e.test(c.find('[name="tcout"]').val())?!0:!1),d.tc=fr.ina.amalia.player.helpers.UtilitiesHelper.convertHourToSeconde(c.find('[name="tc"]').val()),this.validItemTcRange(d,d.tc)?f=!0:d.hasOwnProperty("tcRange")&&(f=!1),f&&("undefined"!=typeof c.find('[name="tcout"]').val()&&(d.tcin=fr.ina.amalia.player.helpers.UtilitiesHelper.convertHourToSeconde(c.find('[name="tcin"]').val()),d.tcout=fr.ina.amalia.player.helpers.UtilitiesHelper.convertHourToSeconde(c.find('[name="tcout"]').val())),d.label=fr.ina.amalia.player.helpers.UtilitiesHelper.htmlEscape(c.find('[name="label"]').val()),d.selected=!1,d.formCreated=!1,a.remove(),this.metadataManager.removeSelectedItem(b)),f},validItemTcRange:function(a,b){var c=!1;return null!==a&&"object"==typeof a&&a.hasOwnProperty("tcRange")&&(a.tcRange.hasOwnProperty("min")&&a.tcRange.hasOwnProperty("max")?c=b>a.tcRange.min&&b<a.tcRange.max:a.tcRange.hasOwnProperty("min")?c=b>a.tcRange.min&&b<=this.tcout:a.tcRange.hasOwnProperty("max")&&(c=b>=this.tcin&&b<a.tcRange.max)),c},updateFormItems:function(){for(var a=this.container.find("ul.listOfSelectedItems li.item"),b=0;b<a.length;b++){var c=$(a[b]).find("form.form-data").data("metadata");"object"==typeof c&&c.hasOwnProperty("selected")&&c.selected===!0?$.each($(a[b]).find(".form-data"),this.updateFormItem):"object"==typeof c&&c.hasOwnProperty("selected")&&c.selected===!1&&this._closeItem($(a[b]))}},updateFormItem:function(a,b){var c=$(b),d=c.data("metadata");d.hasOwnProperty("label")&&(c.find("span.data-model-label").html(d.label),c.find("input.data-model-label").val(d.label)),d.hasOwnProperty("tc")&&(c.find("span.data-model-tc").html(c.find("span.data-model-tc").attr("data-label")+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(d.tc,"ms")),c.find("input.data-model-tc").val(fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(d.tc,"ms"))),d.hasOwnProperty("tcin")&&(c.find("span.data-model-tcin").html(c.find("span.data-model-tcin").attr("data-label")+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(d.tcin,"ms")),c.find("input.data-model-tcin").val(fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(d.tcin,"ms"))),d.hasOwnProperty("tcout")&&(c.find("span.data-model-tcout").html(c.find("span.data-model-tcout").attr("data-label")+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(d.tcout,"ms")),c.find("input.data-model-tcout").val(fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(d.tcout,"ms")))},onFormEdit:function(a){var b=$(a.currentTarget);b.find(".text").html("").hide(),b.find("input").show().focus()},onFormFocusout:function(a){var b=$(a.target),c=b.parent().find(".text");c.text(c.attr("data-label")+b.val()).show(),b.parents("li.item").find(".button.valid").addClass("on"),b.hide()},onSaveForm:function(a){var b=a.data.self._validateItem($(a.currentTarget).parents("li.item").first(),a.data.self.metadataId);b?a.data.self.mediaPlayer.getMediaPlayer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:a.data.self.metadataId}):$(a.currentTarget).parents("li.item").first().addClass("error")},onCloseForm:function(a){a.data.self._closeItem($(a.currentTarget).parents("li.item").first()),a.data.self.mediaPlayer.getMediaPlayer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:a.data.self.metadataId})},onDeleteItem:function(a){var b=$(a.currentTarget).parents("li.item").first(),c=parseInt(b.attr("class").match(/item-([0-9]+)/)[1]),d=b.find("form").first(),e=d.data("metadata");if(e.tc=null,e.tcin=null,e.tcout=null,e.label=null,e.selected=!1,e.formCreated=!1,a.data.self.metadataManager.removeSelectedItem(c),b.remove(),e.deleted=!0,e.hasOwnProperty("subItem")&&e.subItem===!0){var f=a.data.self.mediaPlayer.getMetadataById(a.data.self.metadataId);a.data.self.localisationManager.updateSpacialLocBlock(f)}b.remove(),a.data.self.mediaPlayer.getMediaPlayer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:a.data.self.metadataId})},onSelectedMetadataChange:function(a,b){for(var c=a.data.self.container.find("ul.listOfSelectedItems li.item"),d=0;d<c.length;d++)a.data.self._closeItem($(c[d]));a.data.self.metadataId=null!==b.metadataId?b.metadataId.toString():null,a.data.self.clearMessage()},onAddItem:function(a){if(null!==a.data.self.metadataId&&""!==a.data.self.metadataId){var b=null,c="";if(null!==a.data.self.metadataId){var d=a.data.self.mediaPlayer.getBlockMetadata(a.data.self.metadataId),e=null!==d&&d.hasOwnProperty("type")?d.type:"";c=a.data.self.bindingManager.getLinetypeWithDataType(e)}switch(c){case fr.ina.amalia.player.PluginBindingManager.pluginTypes.TIMELINE_SEGMENT:b=[{tcin:a.data.self.mediaPlayer.getCurrentTime(),tcout:Math.min(a.data.self.mediaPlayer.getCurrentTime()+a.data.self.mediaPlayer.getDuration()*Math.min(a.data.self.settings.defaultPercentWidth,1),a.data.self.mediaPlayer.getDuration()),label:"New segment",tclevel:1,selected:!0,formCreated:!1}],a.data.self.mediaPlayer.addMetadataById(a.data.self.metadataId,b),a.data.self.clearMessage();break;case fr.ina.amalia.player.PluginBindingManager.pluginTypes.TIMELINE_IMAGE:b=[{tc:a.data.self.mediaPlayer.getCurrentTime(),label:"New Point",tclevel:1,selected:!0,formCreated:!1}],a.data.self.mediaPlayer.addMetadataById(a.data.self.metadataId,b),a.data.self.clearMessage();break;case fr.ina.amalia.player.PluginBindingManager.pluginTypes.TIMELINE_CUEPOINT:b=[{tc:a.data.self.mediaPlayer.getCurrentTime(),label:"New Point",tclevel:1,selected:!0,formCreated:!1}],a.data.self.mediaPlayer.addMetadataById(a.data.self.metadataId,b),a.data.self.clearMessage();break;default:a.data.self.setMessage([fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_ITEMS_EDITOR_NEED_METADTA_ITEM_TYPE],"error")}}else a.data.self.setMessage([fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_ITEMS_EDITOR_NEED_METADTA],"error")},onClearItems:function(a){for(var b=a.data.self.container.find("ul.listOfSelectedItems li.item"),c=0;c<b.length;c++)a.data.self._closeItem($(b[c]));a.data.self.mediaPlayer.getMediaPlayer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:a.data.self.metadataId})},onValidateItems:function(a){for(var b=a.data.self.container.find("ul.listOfSelectedItems li.item"),c=0;c<b.length;c++){var d=a.data.self._validateItem($(b[c]));d||$(b[c]).addClass("error")}a.data.self.mediaPlayer.getMediaPlayer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:a.data.self.metadataId})},onDataChange:function(a,b){b.id===a.data.self.metadataId&&a.data.self.updateFormItems()},onSelectedItemsChange:function(a){null!==a.data.self.metadataId&&""!==a.data.self.metadataId&&(a.data.self.updateFormItems(),a.data.self.updateSelectedItems()),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"EndDataChange")}});